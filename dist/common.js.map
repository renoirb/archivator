{"version":3,"sources":["../src/common.js"],"names":["file","data","fsa","readFile","err","readCachedError","readCached","recv","configObj","Promise","resolve","load","cheerioLoad","coroutine","gen","coroutineHandler","args","g","next","readLines","path","fd","openSync","stats","fstatSync","line","size","parseCsvLine","toString","closeSync","url","selector","truncate","split","slug","handleIndexSourceErrors","errorObj","code","Boolean","dirName","dirname","createDirectory","fileContents","msg","writeTextFile","Error","console","error","message","figureOutTruncateAndSelector","sourceArgument","length"],"mappings":"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","file":"common.js","sourcesContent":["'use strict';\n\nimport fs from 'fs';\nimport pathutil from 'path';\nimport cheerio from 'cheerio';\nimport * as fsa from 'async-file';\nimport lines from 'gen-readlines';\nimport slugifier from './normalizer/slugs';\n\n/**\n * Co Routine - A Generator factory helper\n *\n * Pass a Generator closure and Immediately Invoke that helper\n * so that we can iterate using generators as async handlers.\n *\n * This pattern is used so we can use generators as async consumers\n * or as async handlers.\n */\nfunction coroutine(gen) {\n  return function coroutineHandler(...args) {\n    const g = gen(...args);\n    g.next();\n    return g;\n  };\n}\n\nfunction * readLines(path) {\n  const fd = fs.openSync(path, 'r');\n  const stats = fs.fstatSync(fd);\n  for (const line of lines(fd, stats.size)) {\n    yield parseCsvLine(line.toString());\n  }\n  fs.closeSync(fd);\n}\n\nfunction parseCsvLine(line) {\n  const [url, selector = '', truncate = ''] = line.split(';');\n  const slug = slugifier(url);\n  return {url, slug, selector, truncate};\n}\n\nfunction handleIndexSourceErrors(errorObj) {\n  if (errorObj.code === 'ENOENT' && Boolean(errorObj.path)) {\n    const dirName = pathutil.dirname(errorObj.path);\n    fs.createDirectory(dirName);\n    const fileContents = 'http://renoirb.com;#contents;';\n    const msg = `File \"${errorObj.path}\" did not exist, we created one. Try again.`;\n    fs.writeTextFile(errorObj.path, fileContents, 'utf8');\n    throw new Error(msg);\n  }\n  // Handle error codes below #TODO\n  // if (errorObj.code === 'ENOTFOUND')\n  console.error('handleIndexSourceErrors', errorObj);\n}\n\nasync function readCached(file) {\n  try {\n    const data = await fsa.readFile(file, 'utf8');\n    return data;\n  } catch (err) {\n    readCachedError(err);\n    return {};\n  }\n}\n\nfunction readCachedError(errorObj) {\n  // Handle error codes below #TODO\n  switch (errorObj.code) {\n    case 'ENOENT':\n      // ENOENT: no such file or directory, open '...' Handle differently? #TODO\n      console.error(`readCachedError: Could not access file at \"${errorObj.path}\"`);\n      break;\n    default:\n      console.error(`readCachedError: ${errorObj.message}`);\n      break;\n  }\n}\n\n// Make possible to do extractLinks, markdownify, ... in parallel TODO\nasync function cheerioLoad(recv, configObj = {}) {\n  return new Promise(resolve => resolve(cheerio.load(recv, configObj)));\n}\n\n/**\n * Given every row in source file .csv\n * http://example.org/a/b.html;selector;truncate\n *\n * selector is the CSS selector where the main content is\n * truncate is a list of CSS selectors to strip off\n */\nfunction figureOutTruncateAndSelector(sourceArgument) {\n  // If we know exactly where the main content is, otherwise grab the whole\n  // document body.\n  const selector = (sourceArgument.selector.length === 0) ? 'body' : `${sourceArgument.selector}`;\n  // Truncate is to strip off any patterns we do not want\n  // as part of our archived article.\n  let truncate = (sourceArgument.truncate.length === 0) ? '' : `${sourceArgument.truncate},`;\n  truncate += 'script,style,noscript';\n  return {selector, truncate};\n}\n\nexport {\n  readCached,\n  readLines,\n  coroutine,\n  parseCsvLine,\n  handleIndexSourceErrors,\n  figureOutTruncateAndSelector,\n  cheerioLoad\n};\n"]}