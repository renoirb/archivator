{"version":3,"sources":["../src/transformer.js"],"names":["recv","source","loaded","then","selector","truncate","shard","remove","links","Set","each","_","element","href","attr","hrefObj","add","origin","pathname","err","extractLinks","cheerioConfig","assets","potential","isInlineImage","test","extractAssets","matches","p","Promise","resolve","reduced","m","forEach","src","url","match","name","dest","slug","push","handleAssets","console","log","length","asset","assetSrcOrigin","domainsBlacklist","includes","hostname","download","catch","downloadError","downloadAssets","fileName","fileExists","fsa","exists","ok","createWriteStream","body","pipe","sourceList","cachedFilePath","cachedFileName","cached","cacheJsonRepresentation","cacheJsonFile","writeTextFile","JSON","stringify","error","main","list","all","transformer","normalizeWhitespace","xmlMode","decodeEntities","errorObj","code","message"],"mappings":"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","file":"transformer.js","sourcesContent":["'use strict';\n\n/**\n * Transformer\n *\n * Read cached HTML files, transform them so we get only the main content\n */\n\n// cheerio, or https://github.com/lapwinglabs/x-ray\n// http://noodlejs.com/#Overview\nimport {URL} from 'url';\n\nimport fetch from 'node-fetch';\nimport * as fsa from 'async-file';\n\nimport {readCached, figureOutTruncateAndSelector, cheerioLoad} from './common';\nimport hasher from './normalizer/hash';\nimport assetizer from './normalizer/assets';\n\nconst cheerioConfig = {normalizeWhitespace: true, xmlMode: false, decodeEntities: true};\n\nconst domainsBlacklist = ['in.getclicky.com', 's7.addthis.com', 'c.statcounter.com', 'sb.scorecardresearch.com', 'pubads.g.doubleclick.net', 'googleads.g.doubleclick.net'];\n\nasync function extractLinks(recv, source) {\n  const loaded = cheerioLoad(recv);\n  return loaded.then(shard => {\n    const {selector, truncate} = figureOutTruncateAndSelector(source);\n    shard(truncate).remove();\n    shard(selector);\n    const links = new Set();\n    shard('a[href]').each((_, element) => {\n      const href = shard(element).attr('href');\n      try {\n        const hrefObj = new URL(href);\n        links.add(`${hrefObj.origin}${hrefObj.pathname}`);\n      } catch (err) { }\n    });\n    return links;\n  });\n}\n\nasync function extractAssets(recv) {\n  const loaded = cheerioLoad(recv, cheerioConfig);\n  return loaded.then(shard => {\n    // We do not need duplicates\n    const assets = new Set();\n    /**\n     * Iterate with other types of assets.\n     * TODO\n     */\n    shard('body img[src]').each((_, element) => {\n      const potential = shard(element).attr('src');\n      // or is in a blacklist?\n      const isInlineImage = /;base64,/.test(potential);\n      if (isInlineImage === false) {\n        assets.add(potential);\n      }\n    });\n    // We can return an Array once done\n    return [...assets];\n  });\n}\n\n/**\n * Rework each asset so we can prepare to fetch\n *\n * Input is a list of resources in many possible format\n *\n * e.g.\n * matches = [ \"http://renoirboulanger.com/wp-content/themes/twentyseventeen/assets/images/header.jpg\"\n *            ,\"https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png\"\n *            ,\"https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png\"\n *            ,\"//www.gravatar.com/avatar/cbf8c9036c204fe85e15155f9d70faec?s=500\"\n *            ,\"/wp-content/themes/renoirb/assets/img/zce_logo.jpg\" ]\n *\n * source = { url: \"http://renoirboulanger.com/page/3/\"\n *               ,slug: 'renoirboulanger.com/page/3\"}\n *\n * Running handleAssets(matches, source) gives us a cleaned up list of assets where is a good guess\n * the asset might be found so we can make a copy and archive it.\n *\n * Notice:\n * - Each dest file are hashes with extension\n * - Gravatar sample started by //, and below, at src value, we'll have over http\n * - zce_logo.png is in /wp-content/..., but below at src value, it's on renoirboulanger.com\n *\n * e.g.\n * {\n *   \"assets\": [{\n *     \"src\": \"http://renoirboulanger.com/wp-content/themes/twentyseventeen/assets/images/header.jpg\",\n *     \"match\": \"http://renoirboulanger.com/wp-content/themes/twentyseventeen/assets/images/header.jpg\",\n *     \"dest\": \"renoirboulanger.com/page/3/430e2156af17010e0d8ffcd726a95595fa71a4fd.jpg\"\n *   },{\n *     \"src\": \"https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png\",\n *     \"match\": \"https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png\",\n *     \"dest\": \"renoirboulanger.com/page/3/b41de0a18bbb0871b22e0f5c466b3cd2f498807d.png\"\n *   },{\n *     \"src\": \"http://www.gravatar.com/avatar/cbf8c9036c204fe85e15155f9d70faec?s=500\",\n *     \"match\": \"//www.gravatar.com/avatar/cbf8c9036c204fe85e15155f9d70faec?s=500\",\n *     \"dest\": \"renoirboulanger.com/page/3/63dc122dfd3c702e12714fbe4ba744e463c49edb\"\n *   },{\n *     \"src\": \"http://renoirboulanger.com/wp-content/themes/renoirb/assets/img/zce_logo.jpg\",\n *     \"match\": \"/wp-content/themes/renoirb/assets/img/zce_logo.jpg\",\n *     \"dest\": \"renoirboulanger.com/page/3/840257d7de220958ca4cc05a3c0ee337e2b0401d.jpg\"\n *   }]\n * }\n */\nasync function handleAssets(matches, source) {\n  // console.log('handleAssets', [matches, source]); // DEBUG\n  const p = new Promise(resolve => resolve(matches));\n  return p.then(m => {\n    const reduced = [];\n    m.forEach(match => {\n      const src = assetizer(source.url, match);\n      const name = hasher(src);\n      const dest = `${source.slug}/${name}`;\n      reduced.push({src, match, dest, name});\n    });\n    return reduced;\n  });\n}\n\nasync function downloadAssets(assets) {\n  console.log(`    assets:`);\n  console.log(`      length: ${assets.length}`);\n  if (assets.length > 0) {\n    // console.log(`      matches:`);\n    for (const asset of assets) {\n      // if (asset.src) is in blacklist #TODO\n      const assetSrcOrigin = new URL(asset.src);\n      if (domainsBlacklist.includes(assetSrcOrigin.hostname) === false) {\n        await download(asset).catch(downloadError);\n      }\n    }\n  }\n  console.log(`\\n`);\n}\n\nasync function download({src, dest}) {\n  const fileName = `archive/${dest}`; // Make parent folder configurable #TODO\n  const fileExists = await fsa.exists(fileName);\n  // console.log(`      - src: ${src}`);\n  if (fileExists === false) {\n    // Should we pass a User-Agent string? #TODO\n    // ... and a Referrer. As if we downloaded it from a UA?\n    const recv = await fetch(src);\n    if (recv.ok === true) {\n      // console.log(`        dest: ${fileName}`);\n      const dest = await fsa.createWriteStream(fileName);\n      recv.body.pipe(dest);\n      // console.log(`        status: OK`);\n    } else {\n      console.log(`        status: ERR, could not download.`);\n    }\n  }\n}\n\nfunction downloadError(errorObj) {\n  switch (errorObj.code) {\n    case 'ECONNREFUSED':\n      console.error(`downloadError (code ${errorObj.code}): Could not download ${errorObj.message}`);\n      break;\n    case 'ECONNRESET':\n      console.error(`downloadError (code ${errorObj.code}): Could not continue ${errorObj.message}`);\n      break;\n    default:\n      console.error(`downloadError (code ${errorObj.code}): ${errorObj.message}`, errorObj);\n      break;\n  }\n  return Promise.resolve({});\n}\n\nasync function main(sourceList) {\n  for (const source of sourceList) {\n    // console.log(`  ----`);\n    try {\n      const cachedFilePath = `archive/${source.slug}`; // Make parent folder configurable #TODO\n      const cachedFileName = `${cachedFilePath}/cache.html`;\n      const cached = await readCached(cachedFileName);\n      const matches = await extractAssets(cached);\n      const assets = await handleAssets(matches, source);\n      const links = await extractLinks(cached, source);\n      const cacheJsonRepresentation = {source, assets, links};\n      // cacheJsonRepresentation.matches = matches; // DEBUG\n      const cacheJsonFile = `${cachedFilePath}/assets.json`;\n      if ((await fsa.exists(cacheJsonFile)) === false) {\n        await fsa.writeTextFile(cacheJsonFile, JSON.stringify(cacheJsonRepresentation), 'utf8');\n      }\n      console.log(`  - source: ${source.url}`);\n      console.log(`    path:   ${cachedFilePath}/`);\n      await downloadAssets(assets);\n    } catch (err) {\n      // Not finished here, need better error handling #TODO\n      console.error(err);\n    }\n  }\n}\n\nasync function transformer(list) {\n  console.log(`Reading archive to gather image assets:`);\n  await main(list);\n  return Promise.all(list);\n}\n\nexport default transformer;\n"]}